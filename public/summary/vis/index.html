<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css2?family=Unica+One&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
  <title>Accordion </title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(2px);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 360px;
      width: 90%;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
      color: #1a5f3c;
      font-family: "Helvetica Neue", Arial, sans-serif;
    }
    .modal h3 { margin: 0 0 10px; font-size: 18px; }
    .modal p { margin: 0 0 12px; font-size: 14px; color: #2f6f4d; }
    .modal form { display: flex; gap: 8px; }
    .modal input[type="email"] {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #c9c3b5;
      border-radius: 8px;
      font-size: 14px;
    }
    .modal button {
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      background: #1a5f3c;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    .modal .close-btn {
      background: transparent;
      color: #1a5f3c;
      font-weight: 700;
      padding: 6px 8px;
      float: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="page-title">sum<span class="inserted">u</span>mary</h1>
    <p class="subtitle">Guess the animated movie by expanding the summary below.</p>

    <div class="guess-container">
      
      <div class="autocomplete-container">
        <input type="text" class="guess-input" id="guessInput" placeholder="Enter your guess..." autocomplete="off">
        <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
      </div>
      <div class="guess-actions">
      <div class="hint-counter">
      <span class="eye-icon">üëÅÔ∏è</span>
      <span id="hintCount">0</span> splits
      </div>
        <button class="guess-btn" id="guessBtn">Guess</button>
        <button class="guess-btn giveup-btn" id="giveUpBtn">Give up</button>
      </div>
    </div>

    <div id="feedback"></div>

    <select class="movie-select" id="movieSelect">
      <option value="">‚Äî Select a movie ‚Äî</option>
    </select>

    <div class="tree-container" id="treeContainer">
      <p class="hint">Select a movie above to begin exploring its summary.</p>
    </div>

    <div id="emailModal" class="modal-overlay">
      <div class="modal">
        <button class="close-btn" onclick="closeEmailModal()">√ó</button>
        <h3>Play more games</h3>
        <form id="emailForm">
          <input id="emailInput" type="email" name="email" placeholder="you@example.com" required />
          <button type="submit">Submit</button>
        </form>
      </div>
    </div>

  </div>

  <script>

    const LEVELS = ["level_5", "level_4", "level_3", "level_2", "level_1"];
    let currentData = null;
    let parsedLevels = {};
    let visibleNodes = [];
    let currentMovieTitle = null;
    let currentMovieIndex = null;
    let guessCount = 0;
    let clickCount = 0;
    let hasWon = false;

    // Movie catalog loaded from disney_titles.csv
    let movies = [];            // [{ title, index }]
    let movieTitles = [];       // [title]
    let fuse = null;            // Fuse instance for autocomplete

    async function loadMoviesData() {
      try {
        // Load titles from CSV (expects header: movie,url)
        const response = await fetch('disney_titles.csv');
        const text = await response.text();
        const lines = text.trim().split('\n');
        //creates a 1-indexed dataFrame: (titleRaw, index)
        movies = [];
        movieTitles = [];
        for (let i = 1; i < lines.length; i++) {
          const [titleRaw] = lines[i].split(',');
          const title = titleRaw.replace(/^"|"$/g, '').trim();
          const index = i;
          movies.push({ title, index });
          movieTitles.push(title);
        }

        fuse = new Fuse(movieTitles, {
          threshold: 0.3,
          includeScore: true,
          ignoreLocation: true
        });

        const movieSelect = document.getElementById("movieSelect");

        movies.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.index;
          opt.textContent = m.title;
          movieSelect.appendChild(opt);
        });

        selectRandomMovie();
      } catch (err) {
        console.error('Failed to load movies data', err);
      }
    }

    function selectRandomMovie() {
      if (!movies.length) return;
      const indices = [1,2,3,4,5,6,7,8,9,10,11,12,17,18,19,20,21,22,23,24,25,29,30,31,32,33,34,36,38,39,40,41,42,43,44,45,46,47,48,49,50]
      const seenIndices = JSON.parse(localStorage.getItem('seenIndices')) || [];
      const availableIndices = indices.filter(index => !seenIndices.includes(index));

      if (availableIndices.length === 0) {
        localStorage.removeItem('seenIndices');
        return selectRandomMovie();
      }
      const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)] - 1;
      seenIndices.push(randomIndex + 1);
      localStorage.setItem('seenIndices', JSON.stringify(seenIndices));
      
      movieSelect.value = randomIndex + 1;
      const picked = movies[randomIndex];
      currentMovieTitle = picked.title;
      currentMovieIndex = picked.index;
      guessCount = 0;
      clickCount = 0;
      hasWon = false;
      document.getElementById("feedback").innerHTML = "";
      document.getElementById("guessInput").value = "";
      document.getElementById("guessInput").disabled = false;
      document.getElementById("guessBtn").disabled = false;
      document.getElementById("giveUpBtn").disabled = false;
      updateHintCounter();
      loadMovie(currentMovieIndex);
    }

    function normalizeTitle(title) {
      return title
        .toLowerCase()
        .replace(/[\(\)]/g, "") 
        .replace(/\s*(film|movie)\s*/g, "")  
        .replace(/\d{4}/g, "")
        .replace(/[^a-z0-9\s]/g, "")  
        .replace(/\s+/g, " ") 
        .trim();
    }

    function updateHintCounter() {
      document.getElementById("hintCount").textContent = clickCount;
    }

    function checkGuess() {
      if (hasWon) return;
      const guess = document.getElementById("guessInput").value.trim();
      if (!guess) return;
      guessCount++;
      const normalizedGuess = normalizeTitle(guess);
      const normalizedAnswer = normalizeTitle(currentMovieTitle || "");
      const feedbackEl = document.getElementById("feedback");
      if (normalizedGuess === normalizedAnswer) {
        hasWon = true;
        document.getElementById("guessInput").disabled = true;
        document.getElementById("guessBtn").disabled = true;
        document.getElementById("giveUpBtn").disabled = true;
        const photoUrl = getPhotoUrl(currentMovieIndex);
        const photoHtml = photoUrl ? `<img src="${photoUrl}" alt="${escapeHtml(currentMovieTitle)}" class="movie-photo">` : "";
        feedbackEl.innerHTML = `
          <div class="win-message">
            <h2>üéâ Correct!</h2>
            <p>The movie was <strong>${escapeHtml(currentMovieTitle)}</strong></p>
            ${photoHtml}
            <p>You got it in ${guessCount} guess${guessCount !== 1 ? "es" : ""} using ${clickCount} split${clickCount !== 1 ? "s" : ""}!</p>
            <button class="play-again-btn" onclick="selectRandomMovie()">Play Again</button>
            <button class="play-again-btn" onclick="openEmailModal(event)">Play More</button>
            <a class="play-again-btn" style="background: none" href="mailto:eric_xia@brown.edu">
      <p>Feedback: eric_xia@brown.edu</p></a>
          </div>
        `;
      } else {
        feedbackEl.innerHTML = `
          <div class="feedback wrong">
            ‚ùå "${escapeHtml(guess)}" is not correct. Keep trying! (${guessCount} guess${guessCount !== 1 ? "es" : ""})
          </div>
        `;
        document.getElementById("guessInput").value = "";
        document.getElementById("guessInput").focus();
      }
    }

    function giveUp() {
      if (hasWon || !currentMovieTitle) return;
      hasWon = true;
      const feedbackEl = document.getElementById("feedback");
      document.getElementById("guessInput").disabled = true;
      document.getElementById("guessBtn").disabled = true;
      document.getElementById("giveUpBtn").disabled = true;
      const photoUrl = getPhotoUrl(currentMovieIndex);
      const photoHtml = photoUrl ? `<img src="${photoUrl}" alt="${escapeHtml(currentMovieTitle)}" class="movie-photo">` : "";
      feedbackEl.innerHTML = `
        <div class="win-message">
          <p>The movie was <strong>${escapeHtml(currentMovieTitle)}</strong></p>
          ${photoHtml}
          <p>Splits used: ${clickCount}. Guesses made: ${guessCount}.</p>
          <button class="play-again-btn" onclick="selectRandomMovie()">Try another</button>
          <button class="play-again-btn" onclick="openEmailModal(event)">Play More</button>
          <a class="play-again-btn" href="mailto:eric_xia@brown.edu">Feedback</a>
        </div>
      `;
    }

    let selectedIndex = -1;
    const guessInput = document.getElementById("guessInput");
    const dropdown = document.getElementById("autocompleteDropdown");

    // Autocomplete functionality
    function updateAutocomplete() {
      const query = guessInput.value.trim();
      
      if (!query || hasWon) {
        dropdown.classList.remove("show");
        return;
      }

      const results = fuse ? fuse.search(query).slice(0, 8) : [];
      
      if (results.length === 0) {
        dropdown.classList.remove("show");
        return;
      }

      dropdown.innerHTML = results.map((result, idx) => 
        `<div class="autocomplete-item" data-index="${idx}" data-movie="${escapeHtml(result.item)}">${escapeHtml(result.item)}</div>`
      ).join("");
      
      dropdown.classList.add("show");
      selectedIndex = -1;
    }

    // Handle autocomplete item click
    dropdown.addEventListener("click", (e) => {
      const item = e.target.closest(".autocomplete-item");
      if (item) {
        guessInput.value = item.dataset.movie;
        dropdown.classList.remove("show");
        guessInput.focus();
      }
    });

    // Handle keyboard navigation
    guessInput.addEventListener("keydown", (e) => {
      const items = dropdown.querySelectorAll(".autocomplete-item");
      
      if (e.key === "ArrowDown") {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        updateSelection(items);
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection(items);
      } else if (e.key === "Enter") {
        if (selectedIndex >= 0 && items[selectedIndex]) {
          e.preventDefault();
          guessInput.value = items[selectedIndex].dataset.movie;
          dropdown.classList.remove("show");
          checkGuess();
        } else {
          checkGuess();
        }
      } else if (e.key === "Escape") {
        dropdown.classList.remove("show");
      }
    });

    function updateSelection(items) {
      items.forEach((item, idx) => {
        item.classList.toggle("selected", idx === selectedIndex);
      });
      if (selectedIndex >= 0 && items[selectedIndex]) {
        items[selectedIndex].scrollIntoView({ block: "nearest" });
      }
    }

    // Update autocomplete on input
    guessInput.addEventListener("input", updateAutocomplete);

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".autocomplete-container")) {
        dropdown.classList.remove("show");
      }
    });

    // Event listeners for guessing
    document.getElementById("guessBtn").addEventListener("click", checkGuess);
    document.getElementById("giveUpBtn").addEventListener("click", giveUp);
    guessInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && selectedIndex < 0) {
        checkGuess();
      }
    });

    // Populate movie dropdown happens after CSV load
    async function loadMovie(index) {
      try {
        const response = await fetch(`/summary/data/disney/level_summaries/${index}.txt`);
        if (!response.ok) throw new Error("File not found");
        const text = await response.text();
        currentData = JSON.parse(text);
        console.log(currentData)
        parsedLevels = {};
        LEVELS.forEach(level => {
          parsedLevels[level] = parseSummaryLevel(currentData[level] || "");
        });
        // Start with single node covering all 16 level_1 indices
        visibleNodes = [{ start: 0, end: 16 }];
        render();
      } catch (err) {
        document.getElementById("treeContainer").innerHTML =
          `<p class="hint">Error loading movie: ${err.message}</p>`;
      }
    }

    function parseSummaryLevel(text) {
      // Split by numbered items or newlines
      const lines = text.split(/\n/).map(s => s.trim()).filter(Boolean);
      return lines.map(line => line.replace(/^\d+[\.\)]\s*/, "").trim());
    }

    function getLevelAndIndex(start, end) {
      // Determine which level and index a range corresponds to
      const span = end - start;
      if (span === 16) return { level: 0, idx: 0 };      // level_5: 1 item
      if (span === 8) return { level: 1, idx: Math.floor(start / 8) };  // level_4: 2 items
      if (span === 4) return { level: 2, idx: Math.floor(start / 4) };  // level_3: 4 items
      if (span === 2) return { level: 3, idx: Math.floor(start / 2) };  // level_2: 8 items
      if (span === 1) return { level: 4, idx: start };   // level_1: 16 items
      return { level: 4, idx: start };
    }

    function render() {
      const container = document.getElementById("treeContainer");
      container.innerHTML = "";

      // Reset button
      if (visibleNodes.length > 1 || (visibleNodes.length === 1 && visibleNodes[0].end - visibleNodes[0].start < 16)) {
        const resetBtn = document.createElement("button");
        resetBtn.className = "reset-btn";
        resetBtn.textContent = "‚Ü© Reset to top level";
        resetBtn.addEventListener("click", () => {
          visibleNodes = [{ start: 0, end: 16 }];
          render();
        });
        container.appendChild(resetBtn);
      }

      // Grid container
      const grid = document.createElement("div");
      grid.className = "tree-grid";

      visibleNodes.forEach((nodeRange, nodeIdx) => {
        const { level, idx } = getLevelAndIndex(nodeRange.start, nodeRange.end);
        const levelKey = LEVELS[level];
        const items = parsedLevels[levelKey] || [];
        const text = items[idx] || "(No text)";
        const span = nodeRange.end - nodeRange.start;
        const isLeaf = span === 1;

        const node = document.createElement("div");
        let widthClass = "";
        if (level === 1) widthClass = " width-half";      // level_4
        else if (level >= 2) widthClass = " width-quarter"; // level_3, level_2, level_1
        node.className = "node" + (!isLeaf ? " clickable" : " leaf") + widthClass;
        node.innerHTML = `<p>${escapeHtml(text)}</p>`;

        if (!isLeaf) {
          node.addEventListener("click", () => {
            // Increment click counter
            clickCount++;
            updateHintCounter();
            // Split this node into two children
            const mid = nodeRange.start + span / 2;
            const newNodes = [
              ...visibleNodes.slice(0, nodeIdx),
              { start: nodeRange.start, end: mid },
              { start: mid, end: nodeRange.end },
              ...visibleNodes.slice(nodeIdx + 1)
            ];
            visibleNodes = newNodes;
            render();
          });
        }

        grid.appendChild(node);
      });

      container.appendChild(grid);

      // Count visible cards
      const cardCount = visibleNodes.length;
      const allLeaves = visibleNodes.every(n => n.end - n.start === 1);

      const hint = document.createElement("p");
      hint.className = "hint";
      if (allLeaves) {
        hint.textContent = `Fully expanded: ${cardCount} sentences at the most detailed level. Movie: ${currentMovieTitle || ""}`;
      } else {
        hint.textContent = `${cardCount} card${cardCount !== 1 ? "s" : ""} visible. Click any card to expand into more detail.`;
      }
      container.appendChild(hint);
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    disney_photo_map = {
  "48": "48.jpg",
  "49": "49.png",
  "16": "16.svg",
  "8": "8.jpg",
  "14": "14.svg",
  "9": "9.jpg",
  "28": "28.jpg",
  "29": "29.jpg",
  "15": "15.jpg",
  "17": "17.jpg",
  "12": "12.jpg",
  "11": "11.jpg",
  "39": "39.png",
  "10": "10.jpg",
  "38": "38.jpg",
  "21": "21.jpg",
  "35": "35.jpg",
  "34": "34.jpg",
  "20": "20.jpg",
  "22": "22.jpg",
  "36": "36.png",
  "23": "23.png",
  "33": "33.jpg",
  "27": "27.png",
  "26": "26.jpg",
  "18": "18.jpg",
  "24": "24.jpg",
  "30": "30.jpg",
  "31": "31.jpg",
  "25": "25.jpg",
  "19": "19.jpg",
  "42": "42.jpg",
  "4": "4.jpg",
  "5": "5.jpg",
  "43": "43.jpg",
  "7": "7.jpg",
  "41": "41.png",
  "40": "40.jpg",
  "6": "6.jpg",
  "2": "2.jpg",
  "50": "50.jpg",
  "44": "44.jpg",
  "37": "37.svg",
  "45": "45.jpg",
  "3": "3.jpg",
  "47": "47.jpg",
  "1": "1.jpg",
  "46": "46.jpg"
}
    function getPhotoUrl(index) {
      if (!index) return null;
      const filename = disney_photo_map[index];
      return filename ? `../data/disney/photos/${filename}` : null;
    }

    function openEmailModal(e) {
      e?.preventDefault();
      const modal = document.getElementById('emailModal');
      modal.style.display = 'flex';
      document.getElementById('emailInput').focus();
    }
    function closeEmailModal() {
      document.getElementById('emailModal').style.display = 'none';
    }
    document.getElementById('emailForm').onsubmit = function(e) {
      e.preventDefault();
      const email = document.getElementById('emailInput').value;
      fetch('https://script.google.com/macros/s/AKfycbzDqoriWuwxLNVSv2zoj9l-qnN9gDMma1p7efXDhbmIUULT3BLg0vizs7m6-7YF1j0Lug/exec', {
        method: 'POST',
        body: JSON.stringify({ email })
      })
      .then(() => {
        const button = this.querySelector('button');
        button.textContent = 'Submitted ‚úì';
        button.disabled = true;
        setTimeout(() => {
          closeEmailModal();
          button.textContent = 'Submit';
          button.disabled = false;
          this.reset();
        }, 1000);
      })
      .catch(err => {
        console.error(err);
        alert('Error saving email.');
      });
    };
    window.addEventListener('click', (e) => {
      const modal = document.getElementById('emailModal');
      if (e.target === modal) closeEmailModal();
    });

    loadMoviesData();
  </script>
</body>
</html>
